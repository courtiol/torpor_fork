---
title: "An example"
author: "Colin Vullioud"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{An example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## How to use toRpoR ? An example

This vignette presents a suggested workflow of the `toRpoR` package. It is aimed 
in priority at users not familiar with `jags` yet interested in understanding 
the thermo-regulatory pattern of their favorit species. 

This example is based on an example dataset, comming with the package. We develop 
here a complete example on how to use the functions of the package and in which 
order. At each step we also presents the options for the users and the possible 
solution to common problems. This examples his however not an exhaustive presentation
of the package. 


### The data 
The first step in a analysis is to get data. In order to fit a model using the
function `fit_torpor()` we need a set of measure of Metabolic rate $(M)$ and 
the ambient temperature $(T_a)$ at which the measurment have been made. 
These value can be vectors of the same length or two columns of a data-frame. In this 
example, we will use the data taken from the measurment of Geiser (1987) of the 
species *Cercartetus lepidus* that comes with the package. 

The data are accessible with the following command. 

```{r, data}
library(toRpoR)
data(test_data2) 
str(test_data2)
``` 
We get 103 observations of Vo2 of the species *Cercartetus lepidus*

The lower critical temperature (i.e., lower limit of the thermoneutral zone, $T_{lc}$) 
and the basal metabolic rate ($BMR$) are also needed in order to fit the model with 
the `fit_torpor()` function. For the example datasets, these values are found in 
the doccumentation of the data. We can find this by calling the help function on
the data set. In this example by typing: `?test_data2`. 

`fit_torpor()` represents the core function of the model and should be the first
step in any analysis using the `toRpoR` package. Researchers not familiar with 
R and only interested in a visual representation of their data can skip this 
step and use the `plot_torpor()` function directly. This option is however not 
recommended as problems might remain unnoticed. 

The model is fitted with the following call: 

## fit model 
```{r, fit model, cache = TRUE}
model <- fit_torpor(MR = test_data2[, "VO2ms"], Ta = test_data2[, "Ta"],
                    BMR = 1.49, TLC = 28.8,
                    fitting_options = list(ni = 5e+05,
                                           nt = 10,
                                           nb = 3e+05,
                                           nc = 2))
```

The output of the `fit_torpor()` function is a list of class `jagsUI`. This can be
impressive for the user not familiar with jags. Hence the rest of the package offer
several function to make sens of it, check its consistency and represent it graphically. 
Researchers familiar with jagsUI are welcome to build their analysis from that point. 


## Summary

The first step and the best way to have a quick overview on the model outcome is to 
call the function `get_summary()` on the fitted model. This will return a list with the essentials:
A tibble with the parameter estimates, their credible interval and the $\hat{R}$ value.... 

```{r, get_summary}
summary <- get_summary(model)

```

the parameter estimates are accessible by: 

```{r, parameter estimates}
summary$parameter_estimates
```

If the $\hat{R}$ values are distant from 1 we recommand to refit the model and 
increase the number of iteration and the burn-in. This is done by setting the 
parameter `fitting_options = list(ni = "something bigger", nb = "something bigger")`


and the overlap by: 

```{r, overlap}

summary$overlap
``` 


We recommand the user to first check the convergence. User can use the build in 
function from `jagsUI` to check convergence. We also implemented a function to 
check the overlap between the posterior and the prior distribution. We recommand
to check this before analysing the result further. 



## obtain classifcation and/or summary

## check convergence 
R hat mod_output -> summary > 1.1


plot possible avec jagsUI::traceplot(mod, "parameter")

si problem _> augmenter increase ni, nb. 

summary donne overlap aussi 

## check parameters identifiability (sugested by the authors)  
To continue with our analysis of *Cercartetus lepidus* we will check for overlap: 

```{r, check overlap}
# overlap <- check_overlap(mod = model)
# overlap
``` 

The function `check_overlap()` only check overlap for the $T_{lc}$, $T_t$, and 
$\beta_t$. It will return a warning if the overlap is greater between 0.3.
## Evaluate output 

prediction // classification // plot

## plot the data and prediction 


##



