---
title: "An example"
author: "Colin Vullioud"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{An example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## How to use torpor ? An example

This vignette presents a suggested workflow of the `torpor` package. This package is firstly aimed at users not familiar with `rjags`, yet interested in investigating the thermo-regulatory pattern of their model species.
This workflow is based on one of the provided datasets. We go through a complete analysis to illustrate how to use the package functions. At each step we also present some of the options for the users and the possible solution to expected problems. Note, however, that this example is not an exhaustive presentation of the package. 

### The data 
The first step in that analysis is to get data. In order to fit a model using the function `tor_fit()` we need a set of measure of Metabolic rate $M$ and the ambient temperature $T_a$ at which the measurement have been made. These values can be vectors of the same length or two columns of a data-frame. In this example, we will use the data obtained from the Geiser (1987) on Tasmanian pygmy possum (*Cercartetus lepidus*).

The data are accessible with the following command. 

```{r, data}
library(torpor)
data(test_data2) 
str(test_data2)
``` 
We get 103 observations of $VO_2$ at different $T_a$ of the species *Cercartetus lepidus*

he lower critical temperature (i.e., lower limit of the thermoneutral zone, $T_lc$ and the basal metabolic rate $BMR$ are also needed in order to fit the model with the `tor_fit()` function. These two values can be found in the documentation of the dataset (accessible through the help function `?test_data2`) for the present example or should be provided by the researcher when using her/his own data.

`tor_fit()` represents the core function of the model and should be the first step in any analysis using the `torpor` package. Researchers not familiar with `R` and only interested in a visual representation of their data can skip this step and use the `tor_plot()` function directly. This option is however not recommended as problems might remain unnoticed.

## fit model 
The model is fitted with the following call: 

```{r, fit model}
model <- tor_fit(MR = test_data2[, "VO2ms"], Ta = test_data2[, "Ta"],
                    BMR = 1.49, TLC = 28.8,
                    fitting_options = list(ni = 5000,
                                           nt = 10,
                                           nb = 3000,
                                           nc = 2))
```
Note that for the purpose of this vignette we only run 5000 iterations with 3000 
burned-in. The results are thus not trusthworthy.

The output of the `tor_fit()` function is a list of class `jagsUI`. This can be intimidating for the user not familiar with this package. Therefore, the rest of the package offers several functions to make more sense of the model output, check its consistency and represent it graphically. Researchers familiar with `jagsUI` can build their analysis from that point.

## Summary

Once the model if fitted, it is recommended to have an overlook at the results. This can be achieved via the function `tor_summarise()`. This function will return a list with the essentials: A data-frame with mean and median of parameter estimates, the 95% credible interval and the $\hat{R}$ value (i.e. chain convergence estimation). It also reports the parameters’ identifiability. 

```{r, tor summarise}
summary <- tor_summarise(model)
```

the parameter estimates are accessible with: 

```{r, parameter estimates}
summary$parameter_estimates
```

### Check convergence
If the $\hat{R}$ values, given in the summary data-frame are larger than 1.1, we recommend to refit the model and increase the number of iteration and burn-in respectively. This can be done by setting the parameter `fitting_options = list(ni = , nb = )`
It is also possible to look graphicaly at the convergence using the `jagsUI` function `traceplot()`. Let's have a look at the convergence for the parameters `betat` and `betac`. 


```{r, traceplot betat}
jagsUI::traceplot(model, c("betat", "betac"))
```

## check parameters identifiability 
In addition to check of the convergence it is advised to control the identifiability of the parameters. This operation is done by comparing the prior with the posterior distributions. If the overlap is greater than 0.3 the parameter should be considered as not identifiable and a warning will be sent to the user. The parameter identifiability measure is done for the $T_{lc}$, $T_t$, and $\beta_t$. 
The ovelap is also given by the `tor_summarise()` function. Let's continue with our analysis of *Cercartetus lepidus*: 

```{r message=TRUE, warning=TRUE, paged.print=FALSE}
summary$overlap
``` 

## Evaluate output 

Once the basic checks have been done, we can go on with the evaluation of the output. There are two main functions to deal with predictions. `tor_classify()` firstly gives the classification for the raw data based on the predictions of the model. `tor_predict()` further give the predicted $MR$ in torpor and euthermy for a given $T_a$. Finally, we can plot the result using the function `plot_torpor()`.


### Classification 

To look at the classification and the prediction of the data we use the function `tor_classify()`, which will classify the measured points either in torpor or eutermy and returns a data-frame with the measured $MR$, the measured $T_a$, the predicted $MR$ and the classification (predicted_stage).

```{r, tor_classify}
classification <- tor_classify(model)

head(classification)
```



### Prediction 
The `tor_predict()` function is slightly different as it takes a vector of $T_a$ as input and return the predicted $MR$ both in torpor and in euthermy and the 95% credible interval. For example, let's see what are the predicted $MR$ at Ta 22°C. 

```{r, tor_predict}
prediction <- tor_predict(model, 22)

head(prediction)
```

### plot the data and prediction

Finally a built-in function allows the user to plot the results. A few parameters can be modulated by the user directly (labels with `xlab` and `ylab`, colors with `col_torp` and `col_eut`). It is also possible to save the plot using the arguments `pdf = TRUE`. Users can also choose if they prefer a base-R plot or a ggplot via the `plot_type` argument. 

```{r, plot}
plot <- tor_plot(mod = model, plot_type = "ggplot", ylab = "MR")
plot 

plot2 <- tor_plot(MR = test_data2[, "VO2ms"], Ta = test_data2[, "Ta"],
                    BMR = 1.49, TLC = 28.8,
                    fitting_options = list(ni = 5e+03,
                                           nt = 10,
                                           nb = 3e+03,
                                           nc = 2), 
                    plot_type = "base", 
                    ylab = "MR")
plot2

```


The plot can be custom further using either `ggplot` or `graphic`. 


```{r, plot custom}
plot + ggplot2::ggtitle("Cercartetus lepidus") +
  ggplot2::ylab("Test") +
  ggplot2::theme_minimal() +
  ggplot2::theme(legend.position="bottom")
```


